////
////    privacyControl - JS
////    V 1.2 by Louis Mudrack
////    07/27/2023
////
////////////////////

const cmToggle={elementName:"cookie-manager-toggler",className:"closed",textContent:"Manage Cookies"},cmParent={elementName:"cookie-manager"},cmChilds=[{elementName:"cm-close",textContent:"X"},{elementName:"cm-info",childElements:[{elementName:"cm-text",textContent:"Diese Website nutzt Cookies oder Drittanbieterdienste nur mit Ihrem Einverständnis - jederzeit wiederruflich und freiwillig!"},{elementName:"cm-buttons",textContent:"Alle akzeptieren"}]},{elementName:"cm-body"},{elementName:"cm-footer",childElements:[{elementName:"a",className:"reset",textContent:"zurücksetzen"},{elementName:"a",className:"legal",textContent:"Impressum"},{elementName:"a",className:"privacy",textContent:"Datenschutz"}]}];class PrivacyControl{constructor(e={}){this.deps=[],this.initUI(),this.setupEventListeners(),this.createCookies(e)}initUI(){this.createNodes(cmToggle,[],document.body),this.createNodes(cmParent,cmChilds,document.body),this.cookieManager=document.querySelector("cookie-manager"),this.cookieManagerToggler=document.querySelector("cookie-manager-toggler"),this.cmClose=document.querySelector("cm-close"),this.cmBody=document.querySelector("cm-body")}createNodes(e,t,n){const{elementName:c,className:o,textContent:a}=e;let s=document.createElement(c);o&&s.classList.add(o),a&&(s.textContent=a),t.forEach((e=>{const{elementName:t,className:n,textContent:c,childElements:o}=e;let a=document.createElement(t);n&&a.classList.add(n),c&&(a.textContent=c),o&&this.createNodes(e,o,a),s.appendChild(a)})),n.appendChild(s)}setupEventListeners(){this.cmClose.addEventListener("click",(()=>this.close())),this.cookieManagerToggler.addEventListener("click",(()=>this.toggle()))}close(){this.cookieManagerToggler.classList.add("closed"),this.cookieManagerToggler.classList.remove("hide"),this.cookieManager.classList.remove("opened")}open(){this.cookieManager.classList.add("opened"),this.cookieManagerToggler.classList.add("hide"),this.cookieManagerToggler.classList.remove("closed")}toggle(){this.cookieManagerToggler.classList.contains("closed")?this.open():this.close()}createCookies(e){for(const t in e){if(e.hasOwnProperty(t)){const n={cookies:e[t]};this.deps.push(n)}for(const n in e[t]){const c=document.createElement("cm-row");this.cmBody.appendChild(c);const o=document.createElement("label");o.setAttribute("for",`privacy-ctrl:${n}`);const a=document.createElement("input");a.setAttribute("type","checkbox"),a.setAttribute("id",`privacy-ctrl:${n}`),a.setAttribute("name",`${n}`),o.appendChild(a),c.appendChild(o);document.querySelector("cm-buttons").addEventListener("click",(()=>{document.querySelectorAll("input[type=checkbox]").forEach((e=>{e.checked=!0,e.dispatchEvent(new Event("change"))}))}));const s=document.createElement("p");s.textContent="Name:",c.appendChild(s);const i=document.createElement("p");i.textContent=e[t][n].name,c.appendChild(i);const r=document.createElement("p");r.textContent="Anbieter:",c.appendChild(r);const l=document.createElement("p");l.textContent=e[t][n].provider,c.appendChild(l);const d=document.createElement("p");d.textContent="Verwendungszweck:",c.appendChild(d);const m=document.createElement("p");m.textContent=e[t][n].lang,c.appendChild(m);const u=document.createElement("p");u.textContent="Datenschutz:",c.appendChild(u);const h=document.createElement("a");h.textContent="Link",h.setAttribute("href",e[t][n].privacy),h.setAttribute("title",e[t][n].privacy),h.setAttribute("target","_blank"),c.appendChild(h);document.querySelectorAll("cm-footer a").forEach((e=>{e.classList.contains("reset")?e.addEventListener("click",(()=>{document.querySelectorAll("input[type=checkbox]").forEach((e=>{e.checked=!1,e.dispatchEvent(new Event("change"))}))})):e.classList.contains("legal")?(e.setAttribute("href","/impressum"),e.setAttribute("title","Impressum")):e.classList.contains("privacy")&&(e.setAttribute("href","/datenschutzerklaerung"),e.setAttribute("title","Datenschutzerklärung"))}));let p=document.querySelectorAll(`iframe[data-cm-name="${n}"]`),g=document.getElementById(`privacy-ctrl:${n}`);g.dispatchEvent(new Event("change")),g.addEventListener("change",(()=>{p.forEach((e=>{if(g.checked){e.setAttribute("data-cm-accept","true");const t=e.getAttribute("data-cm-src");e.setAttribute("src",t),document.cookie=`${n}=accepted; path=/`}else e.setAttribute("data-cm-accept","false"),e.setAttribute("src","/cookie-manager.placeholder.html"),document.cookie=`${n}=denied; path=/`}))})),p.forEach((c=>{!0===document.cookie.includes(`${n}=accepted`)?g.checked=!0:g.checked=!1,g.dispatchEvent(new Event("change")),"false"===c.getAttribute("data-cm-accept")&&(c.setAttribute("src","/cookie-manager.placeholder.html"),c.addEventListener("load",(()=>{if(c.src.startsWith(window.location.origin)){c.contentDocument.body.innerHTML=c.contentDocument.body.innerHTML.replace(/{{key}}/g,n),c.contentDocument.body.innerHTML=c.contentDocument.body.innerHTML.replace(/{{name}}/g,e[t][n].name),c.contentDocument.body.innerHTML=c.contentDocument.body.innerHTML.replace(/{{provider}}/g,e[t][n].provider),c.contentDocument.body.innerHTML=c.contentDocument.body.innerHTML.replace(/{{desc}}/g,e[t][n].lang),c.contentDocument.body.innerHTML=c.contentDocument.body.innerHTML.replace(/{{policy}}/g,e[t][n].privacy),c.contentDocument.querySelectorAll(`span[data-key="${n}"]`).forEach((e=>{e.addEventListener("click",(()=>{const e=c.getAttribute("data-cm-src");c.setAttribute("src",e),document.cookie=`${n}=accepted; path=/`,g.checked=!0,g.dispatchEvent(new Event("change"))}))}))}})))}))}}}}